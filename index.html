<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Academia Espacial: Física Interactiva v12</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@400;600&family=Exo+2:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        /* D E C O R A C I Ó N: Paleta de colores y variables globales para un tema futurista. */
        :root {
            --primary-color: #00faff;
            --secondary-color: #ff00ff;
            --accent-color: #ffff00;
            --background-dark: #0a0a1f;
            --background-light: #1a1a3f;
            --text-light: #e0fbfc;
            --success-color: #00ff88;
            --error-color: #ff4444;
            --warning-color: #ffaa00;
            --glass-bg: rgba(10, 10, 31, 0.5);
            --glass-border: rgba(0, 250, 255, 0.2);
        }

        /* I N D I C A C I Ó N: Estilos base para el cuerpo del documento. */
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: auto; 
            font-family: 'Exo 2', sans-serif;
            background: var(--background-dark);
            color: var(--text-light);
        }

        .game-wrapper {
            width: 100%; min-height: 100vh; display: flex; flex-direction: column;
            background: linear-gradient(135deg, var(--background-dark) 0%, #1a1a3f 50%, #0a0a1f 100%);
        }

        canvas {
            flex-grow: 1;
            touch-action: none;
            display: block;
            min-height: 200px;
        }
        
        /* D E C O R A C I Ó N: Paneles holográficos rediseñados con efecto de vidrio (glassmorphism). */
        .stats-bar, .controls-container {
            font-family: 'Orbitron', sans-serif;
            color: var(--primary-color);
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px); /* Soporte para Safari */
            border: 1px solid var(--glass-border);
            padding: 1rem;
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            flex-shrink: 0;
            position: relative;
            text-shadow: 0 0 4px var(--primary-color);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37), inset 0 1px 1px rgba(255, 255, 255, 0.1);
            margin: 10px;
            border-radius: 16px;
        }

        .stat, .control-group {
            display: flex; align-items: center; gap: 8px;
            padding: 6px 12px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(0, 250, 255, 0.1);
            transition: all 0.3s ease;
            font-size: 0.8rem;
        }
        
        /* D E C O R A C I Ó N: Botones de selección de tema con efecto de cristal iluminado. */
        .topic-switcher {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px; margin-bottom: 10px; width: 100%;
        }

        .topic-switcher label {
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-size: 0.8rem;
            text-align: center;
            position: relative;
            background: linear-gradient(145deg, rgba(0, 0, 0, 0.25), rgba(0, 0, 0, 0.4));
            border: 1px solid rgba(0, 250, 255, 0.2);
            color: rgba(0, 250, 255, 0.7);
            text-shadow: none;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        .topic-switcher label:hover {
            color: var(--text-light);
            background: rgba(0, 250, 255, 0.1);
            border-color: rgba(0, 250, 255, 0.7);
            transform: translateY(-2px);
            box-shadow: 0 0 15px -5px var(--primary-color);
        }
        
        .topic-switcher input[type="checkbox"] { display: none; }
        
        .topic-switcher input[type="checkbox"]:checked + label {
            background: var(--primary-color);
            color: var(--background-dark);
            border-color: var(--primary-color);
            box-shadow: 0 0 25px var(--primary-color), inset 0 0 10px rgba(255,255,255,0.5);
            text-shadow: none;
            font-weight: bold;
            transform: translateY(-2px) scale(1.05);
        }

        /* D E C O R A C I Ó N: Botones de acción principales con gradiente y borde de neón. */
        .game-button {
            font-family: 'Orbitron', sans-serif;
            background: linear-gradient(145deg, rgba(255,255,255,0.05), rgba(255,255,255,0));
            color: var(--text-light); 
            border: 2px solid transparent;
            background-clip: padding-box;
            border-radius: 12px;
            padding: 10px 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: 0 0 8px rgba(0,0,0,0.7);
            position: relative;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 1.5px;
            font-size: 0.9rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .game-button::before {
            content: '';
            position: absolute;
            top: 0; right: 0; bottom: 0; left: 0;
            z-index: -1;
            margin: -2px; 
            border-radius: inherit; 
            background: linear-gradient(120deg, var(--secondary-color), var(--primary-color), var(--accent-color));
            transition: all 0.4s ease;
        }

        .game-button:hover::before {
            filter: brightness(1.3);
            background-size: 200%;
        }
        
        .game-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.5);
            text-shadow: 0 0 5px var(--text-light);
        }

        .game-button:active { transform: translateY(-1px); }
        .game-button:disabled { background: rgba(0,0,0,0.3); color: rgba(255,255,255,0.3); cursor: not-allowed; box-shadow: none; transform: none; }
        .game-button:disabled::before { background: rgba(255,255,255,0.1); }
        
        /* D E C O R A C I Ó N: Clases de botones para diferentes acciones (éxito, advertencia, error). */
        .btn-success::before { background: linear-gradient(120deg, var(--success-color), var(--primary-color)); }
        .btn-warning::before { background: linear-gradient(120deg, var(--warning-color), var(--accent-color)); }
        #resetButton::before { background: linear-gradient(120deg, var(--error-color), var(--secondary-color)); }

        /* D E C O R A C I Ó N: Estilos para las ventanas modales (preguntas, feedback, etc.). */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(10,10,31,0.6); align-items: center; justify-content: center; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
        .modal-content { background: var(--glass-bg); border: 1px solid var(--primary-color); padding: 20px; border-radius: 16px; text-align: center; width: 90%; max-width: 500px; color: var(--text-light); box-shadow: 0 0 50px -10px rgba(0, 250, 255, 0.4); max-height: 90vh; overflow-y: auto; position: relative; animation: modalAppear 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
        @keyframes modalAppear { from { opacity: 0; transform: scale(0.8) translateY(-20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .modal-content h2 { font-family: 'Orbitron', sans-serif; color: var(--primary-color); margin-bottom: 15px; font-size: 1.5rem; text-shadow: 0 0 10px var(--primary-color); }
        
        /* D E C O R A C I Ó N: Botones de opción dentro de las modales. */
        .option-button { background: rgba(0,0,0, 0.2); border: 1px solid var(--glass-border); color: var(--text-light); width: 100%; padding: 12px; margin: 6px 0; font-size: 0.9rem; cursor: pointer; border-radius: 10px; transition: all 0.3s ease; position: relative; }
        .option-button:hover { background-color: rgba(0, 250, 255, 0.15); border-color: var(--primary-color); transform: scale(1.02); }
        .option-button.selected { background: var(--primary-color); color: var(--background-dark); border-color: var(--primary-color); box-shadow: 0 0 15px var(--primary-color); font-weight: 600; transform: scale(1.02); }
        
        /* I N D I C A C I Ó N: Contenedor para mostrar la solución de las preguntas. */
        #solution-container { margin-top: 20px; padding: 15px; border-top: 1px solid var(--glass-border); text-align: left; font-family: 'Inter', sans-serif; background: rgba(0, 0, 0, 0.3); border-radius: 8px; font-size: 1em; line-height: 1.7; }
        #solution-container h4 { color: var(--accent-color); margin-bottom: 10px; font-family: 'Orbitron', sans-serif; text-shadow: 0 0 5px var(--accent-color); }
        
        /* D E C O R A C I Ó N: Barra de progreso. */
        .progress-bar { width: 100%; height: 6px; background: rgba(0,0,0,0.3); border-radius: 3px; overflow: hidden; margin-top: 5px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.5); }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); border-radius: 3px; transition: width 0.5s ease; box-shadow: 0 0 8px var(--primary-color); }
        
        /* D E C O R A C I Ó N: Indicador de vidas con animación de latido. */
        .lives-container { display: flex; gap: 5px; }
        .heart { color: var(--error-color); font-size: 1.2rem; animation: heartbeat 1.5s infinite; filter: drop-shadow(0 0 4px var(--error-color)); }
        .heart.lost { color: rgba(255,255,255,0.15); animation: none; filter: none; }
        @keyframes heartbeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }
        
        /* D E C O R A C I Ó N: Pie de página con efecto de brillo y nave. */
        .galactic-footer { padding: 15px; background: linear-gradient(0deg, #000008 0%, var(--background-dark) 100%); text-align: center; font-family: 'Orbitron', sans-serif; color: var(--primary-color); text-shadow: 0 0 8px var(--primary-color); position: relative; flex-shrink: 0; overflow: hidden; border-top: 1px solid var(--glass-border); box-shadow: 0 -5px 20px -5px rgba(0, 250, 255, 0.2); }
        .footer-author { font-size: 0.9rem; font-weight: bold; letter-spacing: 1px; position: relative; z-index: 1; transition: transform 0.2s ease; }
        #footer-ship { position: absolute; font-size: 1.5rem; bottom: 8px; left: -50px; }
        
        /* I N D I C A C I Ó N: Estilos para mostrar/ocultar texto en botones según el tamaño de pantalla. */
        .btn-text { display: none; } 
        .btn-icon { display: inline; font-size: 1.2rem; }

        /* I N D I C A C I Ó N: Media Query para el diseño responsivo en pantallas más grandes. */
        @media (min-width: 768px) {
            .stats-bar, .controls-container { padding: 1.25rem; gap: 20px; }
            .stat, .control-group { padding: 8px 15px; gap: 10px; font-size: 1rem; }
            .topic-switcher label { font-size: 0.9rem; padding: 10px 15px; }
            .game-button { font-size: 1rem; padding: 12px 25px; }
            .modal-content { max-width: 600px; padding: 30px; }
            .modal-content h2 { font-size: 1.8rem; }
            .option-button { padding: 15px; font-size: 1rem; }
            .footer-author { font-size: 1rem; }
            .btn-text { display: inline; }
            .btn-icon { margin-right: 8px; font-size: 1rem; }
        }
    </style>
</head>

<body>
    <!-- I N D I C A C I Ó N: Contenedor principal que envuelve toda la aplicación del juego. -->
    <div class="game-wrapper" id="gameWrapper">
        
        <!-- I N D I C A C I Ó N: Barra superior para mostrar las estadísticas vitales del juego. -->
        <div class="stats-bar">
            <div class="stat"><span>Nivel:</span><span id="level" class="font-bold">1</span></div>
            <div class="stat"><span>Vidas:</span><div class="lives-container" id="livesContainer"></div></div>
            <div class="stat"><span>Puntos:</span><span id="score" class="font-bold">0</span></div>
            <div class="stat">
                <span>Progreso:</span>
                <span id="progress" class="font-bold">0/10</span>
                <div class="progress-bar w-16 md:w-20"><div id="progressFill" class="progress-fill"></div></div>
            </div>
            <div class="stat"><span>Nota:</span><span id="grade" class="font-bold">0.0</span><span class="text-yellow-400">⭐</span></div>
            <div class="stat"><span>Tema:</span><span id="currentTopic" class="font-bold">Magnitudes</span></div>
        </div>

        <!-- I N D I C A C I Ó N: El lienzo (canvas) donde se dibujará y animará el juego. -->
        <canvas id="gameCanvas"></canvas>

        <!-- I N D I C A C I Ó N: Panel inferior con todos los controles del juego. -->
        <div class="controls-container">
            <div class="control-group" style="width: 100%;">
                <label class="font-bold text-sm text-center w-full mb-2">SELECCIONAR TEMAS DE FÍSICA</label>
                <div class="topic-switcher">
                    <input type="checkbox" id="topicMagnitudes" name="gameTopics" value="magnitudes" checked><label for="topicMagnitudes">Magnitudes</label>
                    <input type="checkbox" id="topicSI" name="gameTopics" value="si"><label for="topicSI">Sistema SI</label>
                    <input type="checkbox" id="topicCinematica" name="gameTopics" value="cinematica"><label for="topicCinematica">Cinemática</label>
                    <input type="checkbox" id="topicMRU" name="gameTopics" value="mru"><label for="topicMRU">MRU</label>
                    <input type="checkbox" id="topicMRUA" name="gameTopics" value="mrua"><label for="topicMRUA">MRUA</label>
                    <input type="checkbox" id="topicMCU" name="gameTopics" value="mcu"><label for="topicMCU">MCU</label>
                    <input type="checkbox" id="topicGravedad" name="gameTopics" value="gravedad"><label for="topicGravedad">Mov. Vertical</label>
                    <input type="checkbox" id="topicParabolico" name="gameTopics" value="parabolico"><label for="topicParabolico">Mov. Parabólico</label>
                </div>
            </div>
            <div class="flex flex-wrap gap-3 md:gap-4 items-center justify-center w-full">
                <div class="control-group">
                    <label for="levelSelect" class="font-bold">Nivel:</label>
                    <select id="levelSelect" class="bg-gray-800 text-white border border-cyan-400 rounded px-2 py-1 md:px-3 md:py-2">
                        <option value="1">1 (10)</option><option value="2">2 (20)</option><option value="3">3 (30)</option>
                    </select>
                </div>
                <!-- I N D I C A C I Ó N: El texto de este botón cambiará dinámicamente durante el juego. -->
                <button id="startButton" class="game-button btn-success"><span class="btn-icon">🚀</span><span id="startButtonText" class="btn-text">Lanzar</span></button>
                <button id="pauseButton" class="game-button btn-warning" disabled><span class="btn-icon">⏸️</span><span class="btn-text">Pausa</span></button>
                <button id="soundButton" class="game-button"><span class="btn-icon">🔊</span><span class="btn-text">Sonido</span></button>
                <button id="helpButton" class="game-button"><span class="btn-icon">❓</span><span class="btn-text">Ayuda</span></button>
                <button id="resetButton" class="game-button"><span class="btn-icon">🔄</span><span class="btn-text">Reiniciar</span></button>
            </div>
        </div>
        
        <!-- I N D I C A C I Ó N: Pie de página con créditos y la nueva nave. -->
        <footer class="galactic-footer">
            <div id="footer-author" class="footer-author">Autor: Msc Néstor Fabio Montoya Palacios</div>
            <div id="footer-ship">🛸</div>
        </footer>
    </div>
    
    <!-- M A R C A C I Ó N: Estructura HTML para las ventanas modales del juego. -->
    <div id="questionModal" class="modal"><div class="modal-content"><h2 class="!text-xl md:!text-2xl">🎯 Desafío de Física</h2><div id="questionData" class="mb-4 p-3 bg-gray-800 rounded text-xs md:text-sm"></div><div id="questionText" class="text-base md:text-lg mb-6 leading-relaxed"></div><div id="optionsContainer" class="space-y-3"></div><button id="answerButton" class="game-button btn-success mt-6" disabled>✅ Confirmar</button></div></div>
    <div id="feedbackModal" class="modal"><div class="modal-content"><h2 id="feedbackTitle"></h2><p id="feedbackText" class="text-lg mb-4"></p><div id="solution-container" style="display: none;"></div><button id="nextButton" class="game-button btn-success mt-6">▶️ Continuar</button></div></div>
    <div id="helpModal" class="modal"><div class="modal-content"><h2>📚 Manual del Cadete</h2><div class="text-left space-y-4 text-sm"><h3 class="text-cyan-400 font-bold text-lg mb-2">🎯 Misión</h3><p>Pilota tu nave 🚀 y colisiona con meteoritos ☄️. ¡Responde preguntas de física para dominar el universo!</p><h3 class="text-cyan-400 font-bold text-lg mb-2">🎮 Controles</h3><ul class="list-disc list-inside space-y-1 ml-4"><li><strong>Mouse/Dedo:</strong> Mueve la nave</li><li><strong>Colisiones:</strong> Toca meteoritos para aprender</li><li><strong>Temas:</strong> Elige uno o varios temas</li><li><strong>Sonido:</strong> Activa/desactiva con 🔊</li></ul></div><button id="closeHelp" class="game-button mt-6">🚀 ¡Entendido!</button></div></div>
    <div id="levelUpModal" class="modal"><div class="modal-content"><h2 id="levelUpTitle" class="text-2xl"></h2><p id="levelUpText" class="text-lg mb-6"></p><div id="levelUpStats" class="mb-6 p-4 bg-gray-800 rounded"></div><button id="nextLevelButton" class="game-button btn-success">🚀 ¡Siguiente Nivel!</button></div></div>
    <div id="pauseModal" class="modal"><div class="modal-content"><h2>⏸️ Juego Pausado</h2><p class="text-lg mb-6">El tiempo se ha detenido.</p><div class="space-y-4"><button id="resumeButton" class="game-button btn-success">▶️ Reanudar</button><button id="restartFromPause" class="game-button">🔄 Reiniciar</button></div></div></div>
    <div id="finalStatsModal" class="modal"><div class="modal-content"><h2 id="finalStatsTitle"></h2><div id="finalStatsContent" class="text-left space-y-3 mt-4"></div><button id="restartGameButton" class="game-button btn-success mt-6">🚀 Jugar de Nuevo</button></div></div>

</body>

<script>
    // C O M E N T A R I O: Configuración global de MathJax para renderizar fórmulas LaTeX.
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$'], ['\\[', '\\]']],
            processEscapes: true,
            processEnvironments: true
        },
        options: {
            skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
        },
        startup: {
            ready: () => {
                console.log('✅ MathJax cargado y listo.');
                MathJax.startup.defaultReady();
            }
        }
    };

    // I N D I C A C I Ó N: Esta función detecta el tipo de dispositivo para aplicar configuraciones responsivas.
    function getDeviceType() {
        const width = window.innerWidth;
        if (width < 768) return 'mobile';
        if (width < 1024) return 'tablet';
        return 'desktop';
    }
    const deviceType = getDeviceType();

    // I N D I C A C I Ó N: Configuración adaptable que cambia los parámetros del juego según el dispositivo.
    const ADAPTIVE_CONFIG = {
        desktop: { MAX_STARS: 300, COSMIC_OBJECTS: { meteorites: { count: 7, minSpeed: 1.5, maxSpeed: 2.5, size: 25 }, planets: { count: 8, speed: 0, size: 50 }, comets: { count: 4, minSpeed: 2.5, maxSpeed: 3.5, size: 20 } } },
        tablet: { MAX_STARS: 200, COSMIC_OBJECTS: { meteorites: { count: 6, minSpeed: 1.2, maxSpeed: 2.0, size: 22 }, planets: { count: 6, speed: 0, size: 45 }, comets: { count: 3, minSpeed: 2.0, maxSpeed: 3.0, size: 18 } } },
        mobile: { MAX_STARS: 120, COSMIC_OBJECTS: { meteorites: { count: 5, minSpeed: 1.0, maxSpeed: 1.8, size: 20 }, planets: { count: 5, speed: 0, size: 40 }, comets: { count: 2, minSpeed: 1.8, maxSpeed: 2.5, size: 16 } } }
    };

    // C O M E N T A R I O: Configuración principal y constantes del juego.
    const CONFIG = {
        INITIAL_LIVES: 5,
        POINTS_PER_CORRECT: 100,
        LEVEL_BONUS_MULTIPLIER: 50,
        SPACESHIP: { speed: 2, size: 30, trailLength: 20 },
        LEVELS: { 1: { questions: 10, name: "Cadete Espacial" }, 2: { questions: 20, name: "Piloto Avanzado" }, 3: { questions: 30, name: "Comandante Supremo" } },
        ...ADAPTIVE_CONFIG[deviceType]
    };

    console.log(`Dispositivo detectado: ${deviceType}. Configuración optimizada aplicada.`);

    // C O M E N T A R I O: Clase para gestionar el sistema de audio del juego.
    class AudioSystem {
        constructor() { this.enabled = true; this.context = null; }
        async init() { if (this.context) return; try { this.context = new (window.AudioContext || window.webkitAudioContext)(); } catch (error) { this.enabled = false; console.warn("AudioContext no es compatible."); } }
        createTone(frequency, duration, type = 'sine') { if (!this.enabled || !this.context) return; const oscillator = this.context.createOscillator(); const gainNode = this.context.createGain(); oscillator.connect(gainNode); gainNode.connect(this.context.destination); oscillator.frequency.setValueAtTime(frequency, this.context.currentTime); oscillator.type = type; gainNode.gain.setValueAtTime(0.1, this.context.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + duration); oscillator.start(this.context.currentTime); oscillator.stop(this.context.currentTime + duration); }
        play(type) { if (!this.enabled || !this.context) return; switch (type) { case 'success': this.createTone(800, 0.1, 'square'); break; case 'error': this.createTone(200, 0.3, 'sawtooth'); break; case 'collision': this.createTone(300, 0.2, 'triangle'); break; case 'levelUp': this.createTone(600, 0.2, 'sine'); break; } }
        toggle() { this.enabled = !this.enabled; return this.enabled; }
    }

    let gameState = {};
    let audioSystem = null;

    // C O M E N T A R I O: Centraliza todos los elementos del DOM para un acceso rápido.
    const elements = {
        canvas: document.getElementById('gameCanvas'), ctx: null, level: document.getElementById('level'), lives: document.getElementById('livesContainer'),
        score: document.getElementById('score'), progress: document.getElementById('progress'), progressFill: document.getElementById('progressFill'),
        grade: document.getElementById('grade'), currentTopic: document.getElementById('currentTopic'), topicCheckboxes: document.querySelectorAll('input[name="gameTopics"]'),
        levelSelect: document.getElementById('levelSelect'), startButton: document.getElementById('startButton'), startButtonText: document.getElementById('startButtonText'),
        pauseButton: document.getElementById('pauseButton'), helpButton: document.getElementById('helpButton'), resetButton: document.getElementById('resetButton'),
        questionModal: document.getElementById('questionModal'), feedbackModal: document.getElementById('feedbackModal'), helpModal: document.getElementById('helpModal'),
        levelUpModal: document.getElementById('levelUpModal'), pauseModal: document.getElementById('pauseModal'), finalStatsModal: document.getElementById('finalStatsModal'),
        finalStatsTitle: document.getElementById('finalStatsTitle'), finalStatsContent: document.getElementById('finalStatsContent'),
        restartGameButton: document.getElementById('restartGameButton'), questionData: document.getElementById('questionData'),
        questionText: document.getElementById('questionText'), optionsContainer: document.getElementById('optionsContainer'),
        answerButton: document.getElementById('answerButton'), feedbackTitle: document.getElementById('feedbackTitle'),
        feedbackText: document.getElementById('feedbackText'), solutionContainer: document.getElementById('solution-container'),
        nextButton: document.getElementById('nextButton'), footerAuthor: document.getElementById('footer-author'), footerShip: document.getElementById('footer-ship')
    };

    // C O M E N T A R I O: Banco de preguntas de prueba, reducido a 3 por tema.
    const questionDatabase = {
        magnitudes: [
            { type: 'theory', question: '¿Cuál de las siguientes es una magnitud escalar?', options: ['Velocidad', 'Aceleración', 'Temperatura', 'Fuerza'], correct: 2, explanation: 'La temperatura es una magnitud escalar porque se define completamente con un número y una unidad, sin necesidad de una dirección.', difficulty: 1 },
            { type: 'theory', question: '¿Qué caracteriza a una magnitud vectorial?', options: ['Solo tiene magnitud', 'Tiene magnitud, dirección y sentido', 'Solo tiene dirección', 'No tiene unidades'], correct: 1, explanation: 'Las magnitudes vectoriales como la fuerza o la velocidad necesitan magnitud, dirección y sentido.', difficulty: 1 },
            { type: 'theory', question: 'El trabajo realizado por una fuerza ($$W = \\vec{F} \\cdot \\vec{d}$$) es una magnitud:', options: ['Vectorial', 'Escalar', 'Adimensional', 'Fundamental'], correct: 1, explanation: 'El trabajo es una magnitud escalar que se obtiene del producto escalar de dos vectores. El resultado es siempre un escalar.', difficulty: 2 }
        ],
        si: [
            { type: 'theory', question: '¿Cuál es la unidad de la fuerza en el Sistema Internacional (SI)?', options: ['Dina', 'Newton', 'Libra', 'Pascal'], correct: 1, explanation: 'El Newton (N) es la unidad derivada para la fuerza en el SI. Se define como $$1 \\, N = 1 \\, kg \\cdot m/s^2$$.', difficulty: 1 },
            { type: 'calculation', question: 'Un coche se mueve a 72 km/h. ¿Cuál es su velocidad en m/s?', options: ['20 m/s', '25 m/s', '36 m/s', '15 m/s'], correct: 0, explanation: 'Para convertir km/h a m/s, se multiplica por 1000 y se divide por 3600. $$72 \\, \\frac{km}{h} \\cdot \\frac{1000 \\, m}{1 \\, km} \\cdot \\frac{1 \\, h}{3600 \\, s} = 20 \\, \\frac{m}{s}$$.', difficulty: 2 },
            { type: 'theory', question: 'La presión se mide en Pascales (Pa) en el SI. ¿A qué equivale un Pascal?', options: ['$$N \\cdot m^2$$', '$$J / m^3$$', '$$kg / m^2$$', '$$N / m^2$$'], correct: 3, explanation: 'La presión es la fuerza aplicada por unidad de área ($$P = F/A$$), por lo tanto, su unidad es Newton por metro cuadrado ($$N/m^2$$).', difficulty: 3 }
        ],
        cinematica: [
            { type: 'theory', question: '¿Qué estudia la cinemática?', options: ['Las causas que provocan el movimiento', 'La descripción del movimiento sin atender a sus causas', 'El equilibrio estático de los cuerpos', 'La energía asociada al movimiento'], correct: 1, explanation: 'La cinemática es la rama de la mecánica que describe el movimiento (posición, velocidad, aceleración) sin considerar las fuerzas que lo originan.', difficulty: 1 },
            { type: 'theory', question: 'En una gráfica de velocidad vs. tiempo (v-t), el área bajo la curva representa:', options: ['La aceleración media', 'La velocidad media', 'La posición final', 'El desplazamiento'], correct: 3, explanation: 'El área bajo la curva v-t representa el desplazamiento total del objeto, ya que corresponde a la integral de la velocidad respecto al tiempo ($$\\Delta x = \\int v(t) dt$$).', difficulty: 3 },
            { type: 'calculation', question: 'Un explorador camina 3 km hacia el Norte y luego 4 km hacia el Este. ¿Cuál es el módulo de su desplazamiento?', options: ['7 km', '1 km', '5 km', '12 km'], correct: 2, explanation: 'Los dos trayectos forman un triángulo rectángulo. El módulo del desplazamiento es la hipotenusa. Usando el teorema de Pitágoras: $$d = \\sqrt{3^2 + 4^2} = \\sqrt{9 + 16} = \\sqrt{25} = 5 \\, km$$.', difficulty: 2 }
        ],
        mru: [
            { type: 'theory', question: '¿Cuál es la característica principal del Movimiento Rectilíneo Uniforme (MRU)?', options: ['La aceleración es constante y positiva', 'La velocidad es constante', 'La distancia recorrida es siempre cero', 'La aceleración varía con el tiempo'], correct: 1, explanation: 'En un MRU, un objeto se mueve en línea recta a velocidad constante, lo que significa que su aceleración es cero.', difficulty: 1 },
            { type: 'calculation', question: 'Un tren viaja a una velocidad constante de 90 km/h. ¿Qué distancia recorre en 2 horas?', formula: '$$x = v \\cdot t$$', given: { v: 90, t: 2 }, options: ['45 km', '92 km', '180 km', '90 km'], correct: 2, explanation: 'Usando la fórmula del MRU, la distancia es: $$x = 90 \\, km/h \\cdot 2 \\, h = 180 \\, km$$.', difficulty: 1 },
            { type: 'calculation', question: 'Dos coches separados por 200 km parten al mismo tiempo para encontrarse. El coche A va a 40 km/h y el B a 60 km/h. ¿En cuánto tiempo se encuentran?', formula: '$$t_{encuentro} = \\frac{d}{v_A + v_B}$$', given: { d: 200, v_A: 40, v_B: 60 }, options: ['1 h', '2 h', '4 h', '5 h'], correct: 1, explanation: 'La velocidad relativa de acercamiento es $$v_r = 40 + 60 = 100 \\, km/h$$. El tiempo de encuentro es $$t = \\frac{d}{v_r} = \\frac{200 \\, km}{100 \\, km/h} = 2 \\, horas$$.', difficulty: 3 }
        ],
        mrua: [
            { type: 'theory', question: 'En un MRUA, ¿qué magnitud permanece constante durante todo el movimiento?', options: ['La velocidad', 'La posición', 'La aceleración', 'El desplazamiento'], correct: 2, explanation: 'La característica que define al Movimiento Rectilíneo Uniformemente Acelerado (MRUA) es que la aceleración es constante y no nula.', difficulty: 1 },
            { type: 'calculation', question: 'Un coche parte del reposo y acelera a $$2 \\, m/s^2$$. ¿Qué velocidad alcanza después de 5 segundos?', formula: '$$v_f = v_o + a \\cdot t$$', given: { v_o: 0, a: 2, t: 5 }, options: ['5 m/s', '7 m/s', '10 m/s', '2.5 m/s'], correct: 2, explanation: 'Como parte del reposo, $$v_o = 0$$. Usando la fórmula: $$v_f = 0 + (2 \\, m/s^2 \\cdot 5 \\, s) = 10 \\, m/s$$.', difficulty: 1 },
            { type: 'calculation', question: 'Un avión necesita una velocidad de 100 m/s para despegar. Si parte del reposo y su aceleración es de $$5 \\, m/s^2$$, ¿qué distancia de pista necesita?', formula: '$$v_f^2 = v_o^2 + 2 a x$$', given: { v_f: 100, v_o: 0, a: 5 }, options: ['1000 m', '2000 m', '500 m', '100 m'], correct: 0, explanation: 'Usamos la ecuación de Torricelli. $$x = \\frac{v_f^2 - v_o^2}{2a} = \\frac{100^2 - 0^2}{2 \\cdot 5} = \\frac{10000}{10} = 1000 \\, m$$.', difficulty: 3 }
        ],
        mcu: [
            { type: 'theory', question: 'En un Movimiento Circular Uniforme (MCU), ¿qué magnitud permanece constante?', options: ['El vector velocidad lineal', 'El vector aceleración centrípeta', 'La rapidez (módulo de la velocidad lineal)', 'El vector posición'], correct: 2, explanation: 'En un MCU, la rapidez es constante, pero la dirección del vector velocidad cambia continuamente.', difficulty: 2 },
            { type: 'calculation', question: 'Un objeto en una trayectoria circular de 2 m de radio se mueve a una rapidez de 10 m/s. ¿Cuál es su aceleración centrípeta?', formula: '$$a_c = \\frac{v^2}{r}$$', given: { v: 10, r: 2 }, options: ['20 m/s²', '5 m/s²', '50 m/s²', '100 m/s²'], correct: 2, explanation: 'La aceleración centrípeta se calcula como $$a_c = \\frac{v^2}{r} = \\frac{(10 \\, m/s)^2}{2 \\, m} = 50 \\, m/s^2$$.', difficulty: 2 },
            { type: 'calculation', question: 'Un CD gira a 300 revoluciones por minuto (RPM). ¿Cuál es su frecuencia en Hertz (Hz)?', formula: '$$f(Hz) = \\frac{rpm}{60}$$', given: { rpm: 300 }, options: ['50 Hz', '5 Hz', '18000 Hz', '60 Hz'], correct: 1, explanation: 'Para pasar de RPM a Hz (vueltas/segundo), dividimos por 60. $$f = \\frac{300}{60} = 5 \\, Hz$$.', difficulty: 2 }
        ],
        gravedad: [
            { type: 'theory', question: 'En ausencia de aire, si se dejan caer una pluma y una bola de bolos, ¿cuál llega primero al suelo?', options: ['La bola de bolos', 'La pluma', 'Llegan al mismo tiempo', 'Depende de la altura'], correct: 2, explanation: 'En el vacío, todos los objetos caen con la misma aceleración (g), independientemente de su masa.', difficulty: 2 },
            { type: 'calculation', question: 'Se deja caer una manzana desde el reposo. ¿Qué velocidad tendrá después de 3 segundos? (Usa $$g = 10 \\, m/s^2$$)', formula: '$$v_f = v_o + gt$$', given: { v_o: 0, g: 10, t: 3 }, options: ['10 m/s', '3.33 m/s', '30 m/s', '13 m/s'], correct: 2, explanation: 'En caída libre desde el reposo, $$v_f = 0 + (10 \\, m/s^2 \\cdot 3 \\, s) = 30 \\, m/s $$.', difficulty: 1 },
            { type: 'theory', question: 'En el punto más alto de un lanzamiento vertical, la aceleración del objeto es:', options: ['Cero', 'Máxima y hacia arriba', 'Igual a g, hacia abajo', 'Igual a g, hacia arriba'], correct: 2, explanation: 'Aunque la velocidad es cero en el punto más alto, la gravedad sigue actuando, por lo que su aceleración sigue siendo g, apuntando hacia abajo.', difficulty: 3 }
        ],
        parabolico: [
            { type: 'theory', question: 'El movimiento parabólico es una composición de dos movimientos. Estos son:', options: ['Dos MRU', 'Dos MRUA', 'Un MRU en el eje horizontal y un MRUA en el vertical', 'Un MRUA en el eje horizontal y un MRU en el vertical'], correct: 2, explanation: 'El movimiento parabólico se analiza como un MRU en el eje horizontal y un MRUA (debido a la gravedad) en el eje vertical.', difficulty: 2 },
            { type: 'theory', question: 'Despreciando la fricción, ¿bajo qué ángulo de lanzamiento se consigue el máximo alcance horizontal?', options: ['30°', '45°', '60°', '90° (vertical)'], correct: 1, explanation: 'El alcance máximo se logra con un ángulo de lanzamiento de 45°, ya que $$\\sin(2\\theta)$$ es máximo (1) cuando $$\\theta = 45°$$.', difficulty: 3 },
            { type: 'calculation', question: 'Se lanza una piedra horizontalmente desde un acantilado de 45 m de altura. ¿Cuánto tiempo tarda en llegar al agua? (Usa g=10 m/s²)', formula: '$$t = \\sqrt{\\frac{2h}{g}}$$', given: { h: 45, g: 10 }, options: ['4.5 s', '9 s', '2.12 s', '3 s'], correct: 3, explanation: 'El tiempo de caída en un lanzamiento horizontal solo depende de la altura. $$t = \\sqrt{\\frac{2 \\cdot 45}{10}} = \\sqrt{9} = 3 \\, s$$.', difficulty: 2 }
        ]
    };

    // C O M E N T A R I O: Orquesta toda la configuración inicial del juego.
    function initializeGame() {
        elements.ctx = elements.canvas.getContext('2d');
        audioSystem = new AudioSystem();
        resizeCanvas();
        resetGameState();
        setupEventListeners();
        initializeStars();
        initializeCosmicObjects();
        launchFooterShip(); // Inicia la animación del footer
        updateUI();
        gameLoop();
    }

    // C O M E N T A R I O: Ajusta el tamaño del canvas.
    function resizeCanvas() {
        const statsHeight = document.querySelector('.stats-bar').offsetHeight;
        const controlsHeight = document.querySelector('.controls-container').offsetHeight;
        const footerHeight = document.querySelector('.galactic-footer').offsetHeight;
        elements.canvas.width = window.innerWidth;
        elements.canvas.height = window.innerHeight - statsHeight - controlsHeight - footerHeight;
        if (gameState && gameState.spaceship) {
            gameState.spaceship.x = elements.canvas.width / 4;
            gameState.spaceship.y = elements.canvas.height / 2;
            gameState.spaceship.targetX = gameState.spaceship.x;
            gameState.spaceship.targetY = gameState.spaceship.y;
        }
    }

    // C O M E N T A R I O: Restablece el juego a su estado inicial.
    function resetGameState() {
        const levelValue = parseInt(elements.levelSelect.value);
        const selectedTopics = Array.from(elements.topicCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
        if (selectedTopics.length === 0) {
            selectedTopics.push('magnitudes');
            document.getElementById('topicMagnitudes').checked = true;
        }
        gameState = {
            isGameActive: false, isPaused: false, currentLevel: levelValue,
            selectedTopics: selectedTopics, lives: CONFIG.INITIAL_LIVES, score: 0,
            questionsAnswered: 0, correctAnswers: 0, currentLevelProgress: 0,
            currentQuestion: null, selectedAnswer: null, levelQuestionPool: [],
            particles: [], footerParticles: [], stars: [],
            spaceship: { x: elements.canvas.width / 4, y: elements.canvas.height / 2, targetX: elements.canvas.width / 4, targetY: elements.canvas.height / 2, trail: [], angle: 0 },
            cosmicObjects: { meteorites: [], planets: [], comets: [] },
            animationId: gameState.animationId || null
        };
        elements.startButtonText.textContent = 'Lanzar';
    }

    // I N D I C A C I Ó N: Lógica para el fondo estrellado con efecto parallax.
    function initializeStars() {
        gameState.stars = [];
        const starEmojis = ['✨', '⭐', '🌟'];
        const layers = 3; 
        for (let i = 0; i < layers; i++) {
            const starCount = (CONFIG.MAX_STARS / layers) * (i + 1);
            for (let j = 0; j < starCount; j++) {
                const isEmoji = Math.random() < 0.1; 
                gameState.stars.push({
                    x: Math.random() * elements.canvas.width,
                    y: Math.random() * elements.canvas.height,
                    speed: 0.1 + (i * 0.2) + Math.random() * 0.2, 
                    radius: 0.5 + Math.random() * (i + 1),
                    color: `hsl(${200 + Math.random() * 60}, 100%, ${85 + Math.random() * 15}%)`,
                    alpha: 0.3 + (i / layers) * 0.7,
                    isEmoji: isEmoji,
                    emoji: isEmoji ? starEmojis[Math.floor(Math.random() * starEmojis.length)] : null
                });
            }
        }
    }

    function initializeCosmicObjects() {
        const config = CONFIG.COSMIC_OBJECTS;
        gameState.cosmicObjects = { meteorites: [], planets: [], comets: [] };
        for (let i = 0; i < config.meteorites.count; i++) gameState.cosmicObjects.meteorites.push(createCosmicObject('meteorite'));
        for (let i = 0; i < config.comets.count; i++) gameState.cosmicObjects.comets.push(createCosmicObject('comet'));
        const planetEmojis = ['🛰', '🌍', '🌕', '🔴', '🟠', '🟡', '🟢', '🪐', '🟣', '🟣','🟠','🪐','🛸'];
        const minDistance = 150;
        for (let i = 0; i < config.planets.count; i++) {
            let newPlanet, validPosition, attempts = 0;
            do {
                validPosition = true;
                newPlanet = { type: 'planet', x: (elements.canvas.width * 0.1) + (Math.random() * elements.canvas.width * 0.8), y: (elements.canvas.height * 0.1) + (Math.random() * elements.canvas.height * 0.8), speed: 0, size: config.planets.size + Math.random() * 10, angle: Math.random() * Math.PI * 2, rotationSpeed: (Math.random() - 0.5) * 0.005, hasCollided: false, emoji: planetEmojis[i % planetEmojis.length], pulsePhase: Math.random() * Math.PI * 2 };
                for (const existingPlanet of gameState.cosmicObjects.planets) {
                    const dx = newPlanet.x - existingPlanet.x;
                    const dy = newPlanet.y - existingPlanet.y;
                    if (Math.sqrt(dx * dx + dy * dy) < minDistance) { validPosition = false; break; }
                }
                attempts++;
            } while (!validPosition && attempts < 100);
            gameState.cosmicObjects.planets.push(newPlanet);
        }
    }

    // I N D I C A C I Ó N: Lógica para velocidad variable de objetos.
    function createCosmicObject(type) {
        const config = CONFIG.COSMIC_OBJECTS[type + 's'];
        const emoji = type === 'meteorite' ? '🪨' : '☄️';
        const speed = config.minSpeed + Math.random() * (config.maxSpeed - config.minSpeed);
        return { type: type, x: elements.canvas.width + Math.random() * 500, y: Math.random() * elements.canvas.height, speed: speed, size: config.size + Math.random() * 5, angle: Math.random() * Math.PI * 2, rotationSpeed: (Math.random() - 0.5) * 0.05, hasCollided: false, emoji: emoji };
    }

    // C O M E N T A R I O: Configura todos los event listeners del juego.
    function setupEventListeners() {
        // I N D I C A C I Ó N: Se ha modificado el listener del botón de inicio/lanzar.
        elements.startButton.addEventListener('click', handleLaunchClick);
        elements.pauseButton.addEventListener('click', togglePause);
        elements.helpButton.addEventListener('click', showHelpModal);
        elements.resetButton.addEventListener('click', resetGame);
        document.getElementById('soundButton').addEventListener('click', () => { if (audioSystem) { const enabled = audioSystem.toggle(); document.getElementById('soundButton').querySelector('.btn-icon').innerHTML = enabled ? '🔊' : '🔇'; } });
        elements.levelSelect.addEventListener('change', () => { if (!gameState.isGameActive) { gameState.currentLevel = parseInt(elements.levelSelect.value); updateUI(); } });
        elements.topicCheckboxes.forEach(cb => cb.addEventListener('change', () => { if (!gameState.isGameActive) { updateSelectedTopics(); updateTopicDisplay(); } }));
        elements.answerButton.addEventListener('click', submitAnswer);
        elements.nextButton.addEventListener('click', continueAfterFeedback);
        document.getElementById('closeHelp').addEventListener('click', closeModal);
        document.getElementById('nextLevelButton').addEventListener('click', advanceLevel);
        document.getElementById('resumeButton').addEventListener('click', resumeGame);
        document.getElementById('restartFromPause').addEventListener('click', resetGame);
        elements.restartGameButton.addEventListener('click', resetGame);
        elements.canvas.addEventListener('mousemove', e => { const rect = elements.canvas.getBoundingClientRect(); gameState.spaceship.targetX = e.clientX - rect.left; gameState.spaceship.targetY = e.clientY - rect.top; });
        elements.canvas.addEventListener('touchmove', e => { e.preventDefault(); const rect = elements.canvas.getBoundingClientRect(); const touch = e.touches[0]; gameState.spaceship.targetX = touch.clientX - rect.left; gameState.spaceship.targetY = touch.clientY - rect.top; }, { passive: false });
        window.addEventListener('resize', () => { resizeCanvas(); initializeStars(); initializeCosmicObjects(); });
        // I N D I C A C I Ó N: Listener para la animación del OVNI del footer.
        elements.footerShip.addEventListener('transitionend', resetFooterShip);
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    // I N D I C A C I Ó N: Nueva función para manejar el clic en el botón "Lanzar".
    function handleLaunchClick() {
        if (!gameState.isGameActive) {
            startGame();
        } else {
            showNextQuestion();
        }
    }

    // C O M E N T A R I O: Lógica de control del juego.
    function startGame() {
        if (gameState.isGameActive) return;
        if (audioSystem) audioSystem.init();
        gameState.isGameActive = true; 
        gameState.isPaused = false;
        elements.pauseButton.disabled = false;
        elements.levelSelect.disabled = true; 
        elements.topicCheckboxes.forEach(cb => cb.disabled = true);
        const pool = gameState.selectedTopics.flatMap(t => (questionDatabase[t] || []).map(q => ({ ...q, topic: t })));
        if (pool.length === 0) { alert("Error: No hay preguntas."); resetGame(); return; }
        shuffleArray(pool);
        gameState.levelQuestionPool = pool;
        
        // I N D I C A C I Ó N: Se cambia el texto del botón y se lanza la primera pregunta.
        elements.startButtonText.textContent = 'Siguiente Pregunta';
        showNextQuestion();
        updateUI();
    }

    function togglePause() { if (!gameState.isGameActive) return; gameState.isPaused = !gameState.isPaused; elements.pauseModal.style.display = gameState.isPaused ? 'flex' : 'none'; }
    function resumeGame() { gameState.isPaused = false; closeModal(); }
    function resetGame() { if (gameState.animationId) cancelAnimationFrame(gameState.animationId); resetGameState(); elements.startButton.disabled = false; elements.pauseButton.disabled = true; elements.levelSelect.disabled = false; elements.topicCheckboxes.forEach(cb => cb.disabled = false); closeModal(); initializeStars(); initializeCosmicObjects(); updateUI(); gameLoop(); }
    function updateSelectedTopics() { const selected = Array.from(elements.topicCheckboxes).filter(cb => cb.checked).map(cb => cb.value); if (selected.length === 0) { document.getElementById('topicMagnitudes').checked = true; selected.push('magnitudes'); } gameState.selectedTopics = selected; }

    // C O M E N T A R I O: Lógica para seleccionar y mostrar preguntas.
    function showNextQuestion() {
        if (!gameState.isGameActive || gameState.isPaused) return;
        const required = CONFIG.LEVELS[gameState.currentLevel].questions;
        if (gameState.currentLevelProgress >= required) { completeLevel(); return; }
        if (gameState.levelQuestionPool.length === 0) { console.warn("Reutilizando preguntas."); const pool = gameState.selectedTopics.flatMap(t => (questionDatabase[t] || []).map(q => ({ ...q, topic: t }))); shuffleArray(pool); gameState.levelQuestionPool = pool; }
        gameState.currentQuestion = gameState.levelQuestionPool.pop();
        
        // I N D I C A C I Ó N: Se deshabilita el botón de lanzar mientras se responde.
        elements.startButton.disabled = true;
        displayQuestion();
    }

    function displayQuestion() {
        const q = gameState.currentQuestion;
        if (!q) return;
        elements.questionData.innerHTML = `<div class="flex justify-between items-center flex-wrap gap-2"><span><strong>Tema:</strong> ${getTopicDisplayName(q.topic)}</span><span><strong>Dificultad:</strong> ${'⭐'.repeat(q.difficulty || 1)}</span></div>`;
        elements.questionText.innerHTML = q.question;
        if (q.formula) elements.questionText.innerHTML += `<div class="math-expression mt-4 text-center text-cyan-300">${q.formula}</div>`;
        if (q.given) {
            let givenHTML = '<div class="math-expression mt-4"><strong>Datos:</strong> ';
            let latexString = '';
            for (const [key, value] of Object.entries(q.given)) { const formattedKey = key.replace(/_(\w+)/, '_{$1}'); latexString += `${formattedKey} = ${value} \\\\ `; }
            givenHTML += `$$${latexString}$$`;
            givenHTML += '</div>';
            elements.questionText.innerHTML += givenHTML;
        }
        displayOptions();
        elements.questionModal.style.display = 'flex';
        renderMath(elements.questionModal);
    }

    function displayOptions() {
        elements.optionsContainer.innerHTML = '';
        gameState.selectedAnswer = null;
        elements.answerButton.disabled = true;
        gameState.currentQuestion.options.forEach((opt, idx) => {
            const btn = document.createElement('button');
            btn.className = 'option-button';
            btn.innerHTML = opt;
            btn.onclick = () => selectOption(idx, btn);
            elements.optionsContainer.appendChild(btn);
        });
        renderMath(elements.optionsContainer);
    }

    function selectOption(index, btnEl) {
        document.querySelectorAll('.option-button').forEach(btn => btn.classList.remove('selected'));
        btnEl.classList.add('selected');
        gameState.selectedAnswer = index;
        elements.answerButton.disabled = false;
    }

    function submitAnswer() {
        if (gameState.selectedAnswer === null) return;
        const isCorrect = gameState.selectedAnswer === gameState.currentQuestion.correct;
        gameState.questionsAnswered++;
        gameState.currentLevelProgress++;
        if (isCorrect) {
            gameState.correctAnswers++;
            gameState.score += CONFIG.POINTS_PER_CORRECT;
            if (audioSystem) audioSystem.play('success');
            showFeedback('🎉 ¡Correcto!', '¡Excelente trabajo, cadete!', true);
        } else {
            gameState.lives--;
            if (audioSystem) audioSystem.play('error');
            showFeedback('❌ Incorrecto', 'Los errores son para aprender. ¡Revisa la solución!', false);
            if (gameState.lives <= 0) { gameOver(); return; }
        }
        elements.questionModal.style.display = 'none';
        updateUI();
    }

    function showFeedback(title, text, isCorrect) {
        elements.feedbackTitle.textContent = title;
        elements.feedbackText.textContent = text;
        const q = gameState.currentQuestion;
        if (q.explanation) {
            elements.solutionContainer.style.display = 'block';
            elements.solutionContainer.innerHTML = `<h4>💡 Explicación:</h4><p>${q.explanation}</p>`;
        } else {
            elements.solutionContainer.style.display = 'none';
        }
        elements.feedbackModal.style.display = 'flex';
        elements.nextButton.onclick = continueAfterFeedback;
        renderMath(elements.feedbackModal);
    }

    // I N D I C A C I Ó N: Ya no lanza la siguiente pregunta, solo habilita el botón.
    function continueAfterFeedback() {
        closeModal();
        const required = CONFIG.LEVELS[gameState.currentLevel].questions;
        if (gameState.currentLevelProgress < required) {
            elements.startButton.disabled = false;
        }
    }

    // C O M E N T A R I O: Lógica de final de nivel y final de juego.
    function completeLevel() {
        const levelName = CONFIG.LEVELS[gameState.currentLevel].name;
        const accuracy = gameState.questionsAnswered > 0 ? (gameState.correctAnswers / gameState.questionsAnswered * 100).toFixed(1) : 0;
        const bonus = gameState.currentLevel * CONFIG.LEVEL_BONUS_MULTIPLIER;
        const grade = calculateGrade().toFixed(1);
        gameState.score += bonus;
        if (audioSystem) audioSystem.play('levelUp');
        document.getElementById('levelUpTitle').textContent = `🏆 Nivel ${gameState.currentLevel} Completado, Cadete 🧑‍🚀`;
        document.getElementById('levelUpText').innerHTML = `¡Felicidades, ${levelName}! Has demostrado tu valía.`;
        document.getElementById('levelUpStats').innerHTML = `<div class="grid grid-cols-2 gap-4 text-sm"><div>Precisión: <span class="text-cyan-400">${accuracy}%</span></div><div>Bonus de Nivel: <span class="text-yellow-400">+${bonus}</span></div><div>Puntaje Total: <span class="text-purple-400">${gameState.score}</span></div><div>Nota Final: <span class="text-yellow-400">${grade} / 5.0 ⭐</span></div></div>`;
        elements.levelUpModal.style.display = 'flex';
        if (gameState.currentLevel >= Object.keys(CONFIG.LEVELS).length) {
            document.getElementById('nextLevelButton').textContent = '🎊 ¡Misión Cumplida!';
            document.getElementById('nextLevelButton').onclick = completeGame;
        } else {
            document.getElementById('nextLevelButton').textContent = '🚀 ¡Siguiente Nivel!';
            document.getElementById('nextLevelButton').onclick = advanceLevel;
        }
    }

    function advanceLevel() { if (gameState.currentLevel < Object.keys(CONFIG.LEVELS).length) { gameState.currentLevel++; gameState.currentLevelProgress = 0; elements.levelSelect.value = gameState.currentLevel; updateUI(); closeModal(); elements.startButton.disabled = false; } else { completeGame(); } }
    function showFinalStats(title) { closeModal(); gameState.isGameActive = false; const accuracy = (gameState.correctAnswers / (gameState.questionsAnswered || 1) * 100).toFixed(1); const grade = calculateGrade().toFixed(1); elements.finalStatsTitle.innerHTML = `${title} 🧑‍🚀`; elements.finalStatsContent.innerHTML = `<div class="grid grid-cols-2 gap-x-4 gap-y-2 text-base"><span class="font-bold text-cyan-300">Puntaje Final:</span><span class="text-right">${gameState.score}</span><span class="font-bold text-cyan-300">Precisión:</span><span class="text-right">${accuracy}%</span><span class="font-bold text-cyan-300">Vidas Restantes:</span><span class="text-right">${gameState.lives} / ${CONFIG.INITIAL_LIVES}</span><span class="font-bold text-cyan-300">Calificación Final:</span><span class="text-right font-bold text-yellow-400">${grade} / 5.0 ⭐</span></div>`; elements.finalStatsModal.style.display = 'flex'; }
    function completeGame() { showFinalStats('🌟 ¡Misión Cumplida!'); }
    function gameOver() { showFinalStats('💀 Misión Fallida'); }

    // C O M E N T A R I O: Funciones de utilidad para modales.
    function showHelpModal() { elements.helpModal.style.display = 'flex'; }
    function closeModal() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); if (gameState.isPaused && !gameState.currentQuestion) resumeGame(); }

    // C O M E N T A R I O: Física y animación de los objetos del juego.
    function updateSpaceship() { const ship = gameState.spaceship; const dx = ship.targetX - ship.x; const dy = ship.targetY - ship.y; ship.x += dx * 0.1; ship.y += dy * 0.1; ship.angle = Math.atan2(dy, dx); ship.trail.push({ x: ship.x, y: ship.y }); if (ship.trail.length > CONFIG.SPACESHIP.trailLength) ship.trail.shift(); }
    function updateCosmicObjects() { if (gameState.isPaused) return; Object.values(gameState.cosmicObjects).flat().forEach((obj, index, arr) => { if (obj.type !== 'planet') { obj.x -= obj.speed; obj.angle += obj.rotationSpeed; if (!obj.hasCollided && checkCollision(gameState.spaceship, obj)) { obj.hasCollided = true; handleCollision(obj); } if (obj.x < -100) arr[index] = createCosmicObject(obj.type); } else { obj.pulsePhase += 0.02; } }); }
    function checkCollision(ship, obj) { const dx = ship.x - obj.x; const dy = ship.y - obj.y; return Math.sqrt(dx * dx + dy * dy) < (CONFIG.SPACESHIP.size + obj.size) / 2; }
    function handleCollision(obj) { if (audioSystem) audioSystem.play('collision'); createParticleExplosion(obj.x, obj.y, 25, gameState.particles); if (obj.type === 'meteorite' && !gameState.isPaused && Math.random() < 0.5) { gameState.isPaused = true; setTimeout(() => { showPhysicsInfo(); }, 100); } }
    function showPhysicsInfo() { const data = [{ title: 'Ecuación de Einstein', content: 'La famosa ecuación $$E=mc^2$$, relaciona la masa y la energía.' }, { title: 'Dilatación del Tiempo', content: 'El tiempo pasa más lento para un observador en movimiento rápido, un efecto clave en la relatividad.' }, { title: 'Segunda Ley de Newton', content: 'Establece que $$ \\vec{F}_{neta} = m \\cdot \\vec{a} $$.' }, { title: 'Curiosidad Universal', content: 'El sonido no viaja en el vacío del espacio. ¡Las explosiones de las películas son silenciosas en la realidad!' }, { title: 'Densidad Extrema', content: 'Una cucharadita de material de una estrella de neutrones pesaría miles de millones de toneladas.' }, { title: 'Entrelazamiento Cuántico', content: 'Dos partículas pueden estar "entrelazadas" de tal forma que el estado de una afecta instantáneamente a la otra, sin importar la distancia.' }, ]; const random = data[Math.floor(Math.random() * data.length)]; elements.feedbackTitle.textContent = `🧑‍🚀 ${random.title}`; elements.feedbackText.innerHTML = ''; elements.solutionContainer.style.display = 'block'; elements.solutionContainer.innerHTML = random.content; elements.feedbackModal.style.display = 'flex'; elements.nextButton.textContent = "🚀 Entendido"; elements.nextButton.onclick = () => { gameState.isPaused = false; closeModal(); }; renderMath(elements.feedbackModal); }
    function createParticleExplosion(x, y, count, particleArray) { for (let i = 0; i < count; i++) particleArray.push({ x, y, vx: (Math.random() - 0.5) * 8, vy: (Math.random() - 0.5) * 8, life: 1, decay: 0.02 + Math.random() * 0.02, color: `hsl(${Math.random() * 60}, 100%, 70%)` }); }
    function updateParticles(particleArray) { if (gameState.isPaused) return; for (let i = particleArray.length - 1; i >= 0; i--) { const p = particleArray[i]; p.x += p.vx; p.y += p.vy; p.life -= p.decay; p.vy += 0.1; if (p.life <= 0) particleArray.splice(i, 1); } }
    function updateStars() { if (gameState.isPaused) return; gameState.stars.forEach(star => { star.x -= star.speed; if (star.x < -5) star.x = elements.canvas.width + 5; }); }
    
    // I N D I C A C I Ó N: Lógica para la nave del pie de página.
    function launchFooterShip() {
        elements.footerShip.style.transition = 'left 10s linear';
        elements.footerShip.style.left = `${window.innerWidth + 50}px`;
    }

    // C O M E N T A R I O: Esta función se llama cuando la transición termina, para reiniciar el movimiento.
    function resetFooterShip() {
        elements.footerShip.style.transition = 'none';
        elements.footerShip.style.left = '-50px';
        gameState.footerShipCollision = false; // Permite una nueva colisión
        // Uso un pequeño timeout para asegurar que el cambio de estilo se aplique antes de reiniciar la transición.
        setTimeout(launchFooterShip, 50); 
    }
    
    // C O M E N T A R I O: Funciones de dibujo en el canvas.
    function drawBackground() { const grad = elements.ctx.createLinearGradient(0, 0, 0, elements.canvas.height); grad.addColorStop(0, '#0a0a1f'); grad.addColorStop(1, '#000008'); elements.ctx.fillStyle = grad; elements.ctx.fillRect(0, 0, elements.canvas.width, elements.canvas.height); }
    function drawStars() { gameState.stars.forEach(star => { elements.ctx.globalAlpha = star.alpha; if (star.isEmoji) { elements.ctx.font = `${star.radius * 2}px Arial`; elements.ctx.fillText(star.emoji, star.x, star.y); } else { elements.ctx.fillStyle = star.color; elements.ctx.beginPath(); elements.ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2); elements.ctx.fill(); } }); elements.ctx.globalAlpha = 1; }
    function drawSpaceship() { const ship = gameState.spaceship; const ctx = elements.ctx; if(ship.trail.length > 1) { ctx.beginPath(); ctx.moveTo(ship.trail[0].x, ship.trail[0].y); for (let i = 1; i < ship.trail.length; i++) { const point = ship.trail[i]; ctx.globalAlpha = (i / ship.trail.length) * 0.5; ctx.lineTo(point.x, point.y); } ctx.strokeStyle = 'rgba(0, 250, 255, 0.5)'; ctx.lineWidth = 3; ctx.stroke(); ctx.globalAlpha = 1; } ctx.save(); ctx.translate(ship.x, ship.y); ctx.rotate(ship.angle); ctx.shadowColor = '#00faff'; ctx.shadowBlur = 15; ctx.font = `${CONFIG.SPACESHIP.size}px Arial`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText('🚀', 0, 0); ctx.restore(); }
    function drawCosmicObjects() { const ctx = elements.ctx; Object.values(gameState.cosmicObjects).flat().forEach(obj => { ctx.save(); ctx.translate(obj.x, obj.y); ctx.rotate(obj.angle); let size = obj.size; if (obj.type === 'planet') { const pulse = 1 + Math.sin(obj.pulsePhase) * 0.05; size *= pulse; ctx.shadowColor = '#4466ff'; ctx.shadowBlur = 15 + Math.sin(obj.pulsePhase) * 5; } else { ctx.shadowColor = '#ffaa00'; ctx.shadowBlur = 10; } ctx.font = `${size}px Arial`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(obj.emoji, 0, 0); ctx.restore(); }); }
    function drawParticles(particleArray) { particleArray.forEach(p => { elements.ctx.globalAlpha = p.life; elements.ctx.fillStyle = p.color; elements.ctx.beginPath(); elements.ctx.arc(p.x, p.y, 3, 0, Math.PI * 2); elements.ctx.fill(); }); elements.ctx.globalAlpha = 1; }
    
    // C O M E N T A R I O: El bucle principal del juego.
    function gameLoop() {
        if (!gameState.isPaused) {
            elements.ctx.clearRect(0, 0, elements.canvas.width, elements.canvas.height);
            drawBackground(); 
            updateStars(); drawStars();
            updateCosmicObjects(); drawCosmicObjects();
            updateSpaceship(); drawSpaceship();
            updateParticles(gameState.particles); drawParticles(gameState.particles);
            updateParticles(gameState.footerParticles); drawParticles(gameState.footerParticles);
        }
        gameState.animationId = requestAnimationFrame(gameLoop);
    }

    // I N D I C A C I Ó N: Función para forzar el renderizado de LaTeX.
    function renderMath(container) {
        if (window.MathJax && window.MathJax.typesetPromise) {
            MathJax.typesetPromise(container ? [container] : undefined).catch(err => console.error('Error al renderizar con MathJax:', err));
        }
    }

    // C O M E N T A R I O: Funciones para actualizar la interfaz de usuario.
    function updateUI() { elements.level.textContent = gameState.currentLevel; elements.score.textContent = gameState.score; const req = CONFIG.LEVELS[gameState.currentLevel].questions; elements.progress.textContent = `${gameState.currentLevelProgress}/${req}`; const progPerc = req > 0 ? (gameState.currentLevelProgress / req) * 100 : 0; elements.progressFill.style.width = `${progPerc}%`; elements.grade.textContent = calculateGrade().toFixed(1); updateLivesDisplay(); updateTopicDisplay(); }
    function updateLivesDisplay() { elements.lives.innerHTML = ''; for (let i = 0; i < CONFIG.INITIAL_LIVES; i++) { const h = document.createElement('span'); h.className = `heart ${i >= gameState.lives ? 'lost' : ''}`; h.textContent = '❤️'; elements.lives.appendChild(h); } }
    function updateTopicDisplay() { const names = gameState.selectedTopics.map(getTopicDisplayName); const display = names.length > 2 ? `${names.slice(0, 2).join(', ')}...` : names.join(' y '); elements.currentTopic.textContent = display; }
    function getTopicDisplayName(topic) { const names = { magnitudes: 'Magnitudes', si: 'SI', cinematica: 'Cinemática', mru: 'MRU', mrua: 'MRUA', mcu: 'MCU', gravedad: 'Vertical', parabolico: 'Parabólico' }; return names[topic] || topic; }
    function calculateGrade() { if (gameState.questionsAnswered === 0) return 0.0; const acc = gameState.correctAnswers / gameState.questionsAnswered; return Math.min(5.0, acc * 5.0); }
    
    // C O M E N T A R I O: Inicia el juego cuando el DOM esté completamente cargado.
    document.addEventListener('DOMContentLoaded', initializeGame);
</script>

</html>
 